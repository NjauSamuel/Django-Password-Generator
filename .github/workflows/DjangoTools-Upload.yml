name: Deploy DjangoTools To Cpanel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to cPanel
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository
      - name: Checkout Code
        uses: actions/checkout@v2.1.0
        with:
          fetch-depth: 2

      # Step 2: Set up Python (Django backend)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' # Match your cPanel Python version

      # Step 3: Collect static files for Django
      - name: Collect Static Files
        run: |
          python manage.py collectstatic --noinput
        env:
          DJANGO_SETTINGS_MODULE: mysite.settings

      # Step 4: Set up Node.js and build assets (frontend)
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '21' # Match the required Node.js version
          
      - name: Install Node.js dependencies
        run: npm install

      - name: Build Assets
        run: npm run build

      # Step 5: Deploy to cPanel using FTP
      - name: FTP Deploy
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: ${{ secrets.SERVER }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}

      # # Step 7: Install Python dependencies and run post-deployment tasks via SSH
      # - name: Install Dependencies via SSH
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USERNAME }}
      #     # Option 1: Use SSH private key (recommended)
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     # Option 2: Use password instead (uncomment if not using key)
      #     # password: ${{ secrets.SSH_PASSWORD }}
      #     port: ${{ secrets.SSH_PORT }}
      #     script: |
      #       # Navigate to your application directory
      #       # Set APP_PATH secret to your cPanel app directory (e.g., ~/public_html or ~/django_app)
      #       cd ${{ secrets.APP_PATH }}
            
      #       # Activate virtual environment if you're using one (common in cPanel)
      #       # Uncomment and adjust path if needed:
      #       # source venv/bin/activate
      #       # Or for cPanel Python apps:
      #       # source ~/virtualenv/django_app/3.11/bin/activate
            
      #       # Install/upgrade Python dependencies
      #       pip install --upgrade pip --user
      #       pip install -r requirements.txt --user
            
      #       # Run Django migrations (optional - uncomment if needed)
      #       # python manage.py migrate --noinput
            
      #       # Restart Python application (choose method based on your cPanel setup)
      #       # Method 1: Touch passenger_wsgi.py for Passenger/WSGI apps
      #       # touch passenger_wsgi.py
      #       # Method 2: Restart via cPanel API (if configured)
      #       # curl -X POST https://your-domain.com:2083/execute/Python/restart_app?app_name=your_app
